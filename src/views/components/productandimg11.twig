{% set items = section.settings.product111 ?? [] %}

<div class="productandimg11">
  {% for row in items %} {% set url = row.prrurl ?? row['product111.prrurl'] ??
  '' %}

  <div
    class="productandimg11__item"
    data-product-url="{{ url|e('html_attr') }}"
  >
    <div class="productandimg11__loading">Loading product...</div>

    {# ✅ بوكس سلة الجاهز #}
    <salla-product-card
      class="productandimg11__card"
      style="display: none"
    ></salla-product-card>
  </div>
  {% endfor %}
</div>

<script>
  (function () {
    function extractIdFromSallaUrl(url) {
      // مثال: /بلوزة/p23491035  => 23491035 + p23491035
      const m = String(url).match(/\/p(\d+)(?:[\/?#]|$)/i);
      if (!m) return { numeric: null, withP: null };
      return { numeric: m[1], withP: "p" + m[1] };
    }

    function waitFor(conditionFn, timeoutMs = 8000, intervalMs = 50) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        const t = setInterval(() => {
          if (conditionFn()) {
            clearInterval(t);
            resolve(true);
          } else if (Date.now() - start > timeoutMs) {
            clearInterval(t);
            reject(new Error("Timeout waiting for Salla SDK"));
          }
        }, intervalMs);
      });
    }

    async function getDetailsTryBoth(productIdNumeric, productIdWithP) {
      const s = window.salla;
      if (!s || !s.product) throw new Error("Salla SDK not available");

      const fn =
        (typeof s.product.getDetails === "function" && s.product.getDetails) ||
        (s.product.api &&
          typeof s.product.api.getDetails === "function" &&
          s.product.api.getDetails);

      if (!fn) throw new Error("getDetails not found");

      // نجرب id رقمي
      try {
        return await fn.call(s.product.api ? s.product.api : s.product, {
          id: productIdNumeric,
        });
      } catch (e) {}

      // نجرب id مع p
      return await fn.call(s.product.api ? s.product.api : s.product, {
        id: productIdWithP,
      });
    }

    function normalizeProduct(res) {
      // نخليها مرنة حسب شكل الريسبونس
      return res?.data?.product || res?.data || res?.product || res;
    }

    async function renderOne(box) {
      const url = box.getAttribute("data-product-url");
      const loading = box.querySelector(".productandimg11__loading");
      const card = box.querySelector(".productandimg11__card");

      if (!url) {
        loading.textContent = "No URL";
        return;
      }

      const ids = extractIdFromSallaUrl(url);
      if (!ids.numeric) {
        loading.textContent = "Invalid product URL";
        return;
      }

      // استنى SDK يبقى جاهز
      await waitFor(() => window.salla && window.salla.product);

      try {
        const res = await getDetailsTryBoth(ids.numeric, ids.withP);
        const product = normalizeProduct(res);

        if (!product || !product.id) throw new Error("Empty product payload");

        // ✅ salla-product-card لازم ياخد JSON string
        card.setAttribute("product", JSON.stringify(product));
        card.style.display = "";
        loading.style.display = "none";
      } catch (e) {
        loading.textContent = "Failed to load product";
        console.error("Product load error:", e);
      }
    }

    document.querySelectorAll(".productandimg11__item").forEach((box) => {
      renderOne(box);
    });
  })();
</script>
