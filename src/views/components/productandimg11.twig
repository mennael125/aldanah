{# 1) خدي عناصر الـ collection بأي شكل راجع #} {% set items =
component.product111.value ?? component.product111 ?? [] %} {% if items|length
%}
<section class="product-img-slider" id="product-img-slider-{{ component.id }}">
  <div class="product-img-slider__wrap">
    <div class="swiper product-img-slider__swiper">
      <div class="swiper-wrapper">
        {% for it in items %} {# 2) اقرأي القيم بأكثر من احتمال (عشان اختلاف
        هيكلة البيانات) #} {% set img = it.img ?? it['product111.img'] ?? '' %}
        {% set url = it.prrurl ?? it['product111.prrurl'] ?? '' %}

        <div class="swiper-slide">
          <div class="product-img-slider__grid">
            <div class="product-img-slider__left">
              <div class="product-slot" data-product-url="{{ url | e }}">
                جاري تحميل المنتج...
              </div>
            </div>

            <div class="product-img-slider__right">
              {% if img %}
              <img
                src="{{ img }}"
                alt="slide image"
                style="
                  width: 100%;
                  height: 100%;
                  object-fit: cover;
                  display: block;
                "
              />
              {% else %} {# للتأكد إن المشكلة من البيانات مش من الـ CSS #}
              <div
                style="padding: 16px; background: #fff; border: 1px dashed #ccc"
              >
                لا توجد صورة في إعدادات السلايد
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="product-img-slider__center">
        <span class="product-img-slider__counter"
          ><span class="current">1</span></span
        >
      </div>
    </div>
  </div>
</section>

<script>
  (function () {
    const root = document.getElementById(
      "product-img-slider-{{ component.id }}"
    );
    if (!root) return;

    // ✅ Swiper (اختياري)
    if (window.Swiper) {
      const counterEl = root.querySelector(
        ".product-img-slider__center .current"
      );
      const swiperEl = root.querySelector(".product-img-slider__swiper");

      const sw = new Swiper(swiperEl, {
        loop: true,
        on: {
          init() {
            update(this);
          },
          slideChange() {
            update(this);
          },
        },
      });

      function update(swiper) {
        const n = (swiper.realIndex || 0) + 1;
        if (counterEl) counterEl.textContent = n;
      }
    }

    // ✅ Load product from URL
    const slots = root.querySelectorAll(".product-slot");

    slots.forEach(async (slot) => {
      const url = (slot.dataset.productUrl || "").trim();

      // لو ده ظهر يبقى المشكلة من الـ Twig (الرابط مش واصل)
      if (!url) {
        slot.innerHTML =
          '<div style="padding:10px;border:1px dashed #ccc;">رابط المنتج غير موجود داخل السلايد</div>';
        return;
      }

      const id = extractProductId(url); // من /p23491035
      if (!id) {
        slot.innerHTML =
          '<div style="padding:10px;border:1px dashed #ccc;">الرابط لا يحتوي على /pID</div>';
        return;
      }

      try {
        // سلة Twilight SDK عندها getDetails() للمنتج :contentReference[oaicite:0]{index=0}
        const product = await getProductDetails(id);
        if (!product) throw new Error("No product data");

        slot.innerHTML = `<custom-salla-product-card shadow-on-hover isSpecial product='${escapeAttr(
          JSON.stringify(product)
        )}'></custom-salla-product-card>`;
      } catch (e) {
        console.error(e);
        slot.innerHTML =
          '<div style="padding:10px;border:1px dashed #f00;">تعذر تحميل المنتج (راجعي Console)</div>';
      }
    });

    function extractProductId(url) {
      const m = url.match(/\/p(\d+)(?:\/|$|\?)/i);
      return m && m[1] ? m[1] : null;
    }

    async function getProductDetails(productId) {
      if (!window.salla) throw new Error("Twilight SDK not found");

      // اختلافات بسيطة بين الثيمات/الإصدارات — نخليها fallbacks
      if (salla?.product?.api?.getDetails) {
        const res = await salla.product.api.getDetails({
          product_id: String(productId),
        });
        return res?.data?.product || res?.product || res?.data;
      }
      if (salla?.product?.getDetails) {
        const res = await salla.product.getDetails(String(productId));
        return res?.data?.product || res?.product || res?.data;
      }

      throw new Error("No getDetails method found");
    }

    function escapeAttr(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/'/g, "&#39;")
        .replace(/"/g, "&quot;");
    }
  })();
</script>
{% endif %}
